
{% extends "base.html" %}

{% block content %}
<div class="card my-4">
  <div class="card-body">
    <h1 class="card-title h4">Upload APE CSV</h1>

    <p class="alert alert-warning">DE-FRY the APE before uploading!</p>

    <form method="post" enctype="multipart/form-data" class="mt-3">
      {% csrf_token %}
      <div class="form-group">
        {{ form.file.label_tag }}
        {{ form.file }}
        {% if form.file.errors %}
          <div class="alert alert-danger mt-2 mb-0">
            {% for e in form.file.errors %}<div>{{ e }}</div>{% endfor %}
          </div>
        {% endif %}
      </div>

      <div class="form-group">
        <button class="btn btn-primary" type="submit">Upload</button>
        <a class="btn btn-secondary" href="">Reset</a>
      </div>
    </form>

    {% if filename %}
      <hr>
      <h2 class="h5">Upload complete</h2>
      <ul class="list-group mb-3">
        <li class="list-group-item"><strong>File:</strong> {{ filename }}</li>
        <li class="list-group-item"><strong>Stored at:</strong> {{ relative_path }}</li>
        <!---<li class="list-group-item"><strong>Line count:</strong> {{ line_count }}</li>--->
      </ul>

    {% if messages %}
      <div class="mt-3">
        {% for message in messages %}
          <div class="alert alert-{{ message.tags|default:'info' }} mb-2" role="alert">
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <!-- Step 2: call stored proc -->
    {% if filename and uploaded_folder %}
    <form method="post" action="{% url 'cims:import' %}">
        {% csrf_token %}
        <input type="hidden" name="folder" value="{{ uploaded_folder }}">
        <input type="hidden" name="filename" value="{{ filename }}">
        <button type="submit" class="btn btn-success" onclick="this.disabled=true; this.form.submit();">
            Run Import
        </button>
    </form>
    {% endif %}

    <small class="text-muted d-block mt-2">
        This will run <code>[sub].[sp_010_Load_Alayacare_Payroll_Export]</code> with the folder and file above.
    </small>
    {% endif %}
  </div>
</div>
{% endblock content %}

{% block rightcontent %}
  <!-- optional right column content -->
{% endblock rightcontent %}
